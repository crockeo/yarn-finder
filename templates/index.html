<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="https://unpkg.com/htmx.org@2.0.3"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body>
    <div class="flex flex-col h-screen w-screen">
      <div class="align-middle flex flex-row justify-between p-2">
        <a class="font-bold">Yarn Finder</a>
        <div class="align-middle flex flex-row space-x-1">
          <div class="font-bold">Color:</div>
          <pre><code id="color-input-text"></code></pre>
          <input id="color-input" type="color" />
        </div>
      </div>

      <div class="flex-grow" id="color-selector"></div>
      <div class="absolute hue-rotate-180 border-2 rounded-full h-8 shadow w-8" id="color-pin" style="visibility:hidden"></div>
    </div>

    <div id="yarn-results"></div>

    <script>
    const input = document.getElementById("color-input");
    const selector = document.getElementById("color-selector");
    const pin = document.getElementById("color-pin");

    let colorPinned = false;
    let hue = 0;
    let saturation = 100;
    let lightness = 100;


    function setBackgroundColor(backgroundColor) {
      document.getElementById("color-input").value = backgroundColor;
      document.getElementById("color-input-text").innerHTML = backgroundColor;
      selector.style = `background-color: ${backgroundColor}`;

      <!-- const urlParams = new URLSearchParams(window.location.search); -->
      <!-- urlParams.set("color", backgroundColor); -->
      <!-- window.location.search = urlParams; -->
    }

    if (!!window.location.hash) {
      setBackgroundColor(window.location.hash);
      const [r, g, b] = deHexify(window.location.hash);
      const [h, s, l] = rgbToHsl(r, g, b);
      const [x, y] = hslToXY(h, s, l);
      showPin(x, y);
    }

    function hsl(hue, saturation, lightness) {
      const [r, g, b] = hslToRgb(hue / 360, saturation / 100, lightness / 100);
      return hexify(r, g, b);
    }

    function hidePin() {
      pin.style = `visibility:hidden;`;
    }

    async function showPin(x, y) {
      const rect = pin.getBoundingClientRect();
      const midX = Math.round(x - (rect.right - rect.left) / 2);
      const midY = Math.round(y - (rect.bottom - rect.top) / 2);
      pin.style = `visibility:visible; left: ${midX}px; top: ${midY}px;`;

      window.location.hash = input.value;
      const res = await fetch(`/yarns/search/${input.value.slice(1)}`)
      document.getElementById("yarn-results").innerHTML = await res.text();
      colorPinned = true;
    }

    function onMouseMove(mouseX, mouseY) {
      const [h, s, l] = xyToHSL(mouseX, mouseY);
      setBackgroundColor(hsl(h, s, l));
    }

    function onMouseClick(mouseX, mouseY) {
      onMouseMove(mouseX, mouseY);
      showPin(mouseX, mouseY);
    }

    function hslToRgb(h, s, l) {
      let r, g, b;
      if (s === 0) {
        r = g = b = l; // achromatic
      } else {
        const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
        const p = 2 * l - q;
        r = hueToRgb(p, q, h + 1/3);
        g = hueToRgb(p, q, h);
        b = hueToRgb(p, q, h - 1/3);
      }

      return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
    }

    function hueToRgb(p, q, t) {
      if (t < 0) t += 1;
      if (t > 1) t -= 1;
      if (t < 1/6) return p + (q - p) * 6 * t;
      if (t < 1/2) return q;
      if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
      return p;
    }

    function rgbToHsl(r, g, b) {
      (r /= 255), (g /= 255), (b /= 255);
      const vmax = Math.max(r, g, b), vmin = Math.min(r, g, b);
      let h, s, l = (vmax + vmin) / 2;

      if (vmax === vmin) {
        return [0, 0, l]; // achromatic
      }

      const d = vmax - vmin;
      s = l > 0.5 ? d / (2 - vmax - vmin) : d / (vmax + vmin);
      if (vmax === r) h = (g - b) / d + (g < b ? 6 : 0);
      if (vmax === g) h = (b - r) / d + 2;
      if (vmax === b) h = (r - g) / d + 4;
      h /= 6;

      return [h * 360, s * 100, l * 100];
    }

    function hexify(r, g, b) {
      const toHex = (x) => {
        const hex = Math.round(x).toString(16);
        return hex.length === 1 ? '0' + hex : hex;
      };
      return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
    }

    function hslToXY(h, s, l) {
      const xPct = h / 360;
      const yPct = 1.0 - s / 100;

      const rect = selector.getBoundingClientRect();
      const x = xPct * (rect.right - rect.left) + rect.left;
      const y = yPct * (rect.bottom - rect.top) + rect.top;
      return [x, y];
    }

    function xyToHSL(x, y) {
      const rect = selector.getBoundingClientRect();
      const xPct = (x - rect.left) / (rect.right - rect.left);
      const yPct = (y - rect.top) / (rect.bottom - rect.top);
      const hue = 360 * xPct;
      const saturation = 100 - (100 * yPct);
      return [hue, saturation, 50];
    }

    function deHexify(rgb) {
      const r = rgb.slice(1, 3);
      const g = rgb.slice(3, 5);
      const b = rgb.slice(5, 7);
      return [parseInt(r, 16), parseInt(g, 16), parseInt(b, 16)];
    }

    selector.addEventListener("mousemove", function (e) {
      if (colorPinned) {
        return;
      }
      onMouseMove(e.pageX, e.pageY);
    });

    selector.addEventListener("click", function (e) {
      onMouseClick(e.pageX, e.pageY);
    });

    pin.addEventListener("click", function (e) {
      colorPinned = false;
      hidePin();
    });

    pin.addEventListener("mousedown", function (e) {
      onMouseMove(e.pageX, e.pageY);
    });

    input.addEventListener("input", function (e) {
      setBackgroundColor(e.target.value);

      const [r, g, b] = deHexify(e.target.value);
      const [h, s, l] = rgbToHsl(r, g, b);
      const [x, y] = hslToXY(h, s, l);
      showPin(x, y);
    });

</script>
  </body>
</html>
